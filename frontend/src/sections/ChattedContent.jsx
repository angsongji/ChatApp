import { useEffect, useState, useRef, useLayoutEffect } from "react";
import { IoMdImages, IoIosClose } from "react-icons/io";
import { useChatStore } from "../store/useChatStore";
import { useMessageStore } from "../store/useMessageStore";

import LoadingPageSkeleton from "../components/LoadingPageSkeleton";
import { FaPaperPlane } from "react-icons/fa6";
import { useAuthStore } from "../store/useAuthStore";

import ChattedContentBegin from "../components/ChattedContentBegin";
import EmojiPickerWrapper from "../components/EmojiPickerWrapper";
import ChattedMessagesWrapper from "../components/ChattedMessagesWrapper";

const ChatWindow = ({ selectedChat }) => {
  const messagesEndRef = useRef(null);
  const fileInputRef = useRef(null);
  const { messages, isSendMessageLoading, sendMessage, sendMessageToStranger } =
    useMessageStore();
  const { authUser } = useAuthStore();
  const [message, setMessage] = useState("");
  const [imageURL, setImageURL] = useState({
    base64_url: "",
    blob_url: "",
  });

  const messagesByChatId =
    selectedChat == null || selectedChat._id == undefined
      ? []
      : messages.filter((msg) => msg.chatId === selectedChat._id);

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [messagesByChatId]);

  useLayoutEffect(() => {
    if (messagesEndRef.current) {
      messagesEndRef.current.scrollIntoView({ behavior: "auto" });
    }
  }, []);

  const handleSubmitMessage = async (e) => {
    e.preventDefault();
    const messageData = {
      text: message,
      image: imageURL.base64_url,
    };
    try {
      setMessage("");
      handleRemoveImage();
      if (selectedChat._id == undefined) {
        const messageDataStranger = {
          ...messageData,
          users: [selectedChat.users[0]._id],
          name: "",
        };
        await sendMessageToStranger(messageDataStranger);
      } else await sendMessage(messageData, selectedChat._id);
    } catch (error) {
      console.error("Error in send message ", error);
    }
  };

  const handleClick = () => {
    fileInputRef.current.click();
  };

  const handleChange = (e) => {
    const file = e.target.files[0];

    if (!file) return;
    if (imageURL.blob_url) URL.revokeObjectURL(imageURL.blob_url);
    const url = URL.createObjectURL(file);
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = async () => {
      setImageURL({
        base64_url: reader.result,
        blob_url: url,
      });
    };
  };

  const handleRemoveImage = () => {
    URL.revokeObjectURL(imageURL.blob_url);
    setImageURL({
      base64_url: "",
      blob_url: "",
    });
  };

  return (
    <div className=" w-full flex flex-col-reverse gap-4 min-h-full max-h-[calc(100vh-25vh)]">
      <form
        onSubmit={handleSubmitMessage}
        className="flex flex-col gap-2 items-center sticky bottom-0 bg-base-100 z-2 px-4 py-2"
      >
        {imageURL.blob_url != "" && (
          <div className="w-full h-fit absolute rounded-md top-0 z-1 left-1/2 -translate-x-[50%] -translate-y-[110%] flex gap-3 md:gap-4 justify-center bg-base-100/30 py-1">
            <div className="h-24 w-auto relative shadow-md">
              <img
                src={imageURL.blob_url}
                className="object-contain w-full h-full"
              />
              <button
                type="button"
                className="bg-base-200 absolute top-0 right-0 translate-x-1/2 rounded-full cursor-pointer"
                onClick={handleRemoveImage}
              >
                <IoIosClose className="text-base md:text-xl" />
              </button>
            </div>
          </div>
        )}

        <div
          className={`${
            isSendMessageLoading ? "block" : "hidden"
          } px-4 absolute right-0 bottom-0 w-full h-fit text-right text-xs md:text-sm -translate-y-[140%] py-1 z-1 bg-base-200`}
        >
          <div
            className={`${
              isSendMessageLoading ? "opacity-100" : "opacity-0"
            } transition-all duration-500 ease-in-out flex gap-2 justify-end`}
          >
            <span>Sending message...</span>
            <div className="w-5 aspect-square">
              <div className="loader !w-full !h-full"></div>
            </div>
          </div>
        </div>

        <div className="flex items-center gap-5 w-full">
          <div className="flex items-center">
            <button
              type="button"
              className="cursor-pointer relative"
              onClick={handleClick}
            >
              <IoMdImages size={25} className="" />
            </button>
            <input
              type="file"
              accept="image/*"
              ref={fileInputRef}
              onChange={handleChange}
              className="hidden"
            />
          </div>
          <EmojiPickerWrapper setMessage={setMessage} />

          <label className="input rounded-box flex-1 border-none h-8">
            <input
              type="search"
              required
              placeholder="Aa..."
              value={message}
              onChange={(e) => setMessage(e.target.value)}
            />
          </label>
          <button
            type="submit"
            className="cursor-pointer"
            disabled={message == "" && imageURL.blob_url == ""}
          >
            <FaPaperPlane
              size={20}
              className={`${
                message == "" && imageURL.blob_url == "" && "text-base-300"
              }`}
            />
          </button>
        </div>
      </form>

      <div className="flex-1 px-4 overflow-auto scrollbar-hide">
        <ChattedMessagesWrapper
          messagesByChatId={messagesByChatId}
          authUser={authUser}
          selectedChat={selectedChat}
        />
        <div ref={messagesEndRef} />
      </div>
    </div>
  );
};

const ChattedContent = () => {
  const { selectedChat } = useChatStore();
  const { isGetMessagesLoading } = useMessageStore();
  if (selectedChat == null) return <ChattedContentBegin />;
  return (
    <div className="w-full h-full">
      {isGetMessagesLoading ? (
        <LoadingPageSkeleton />
      ) : (
        <ChatWindow selectedChat={selectedChat} />
      )}
    </div>
  );
};

export default ChattedContent;
